<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATC Approach Trainer</title>
    <style>
        body {
            background-color: #333;
            color: white;
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
        }
        #atc-map {
            border: 1px solid #666;
            background-color: #222;
            width: 1000px;
            height: 600px;
        }
        .aircraft rect {
            fill: white;
            stroke: black;
        }
        .aircraft text {
            fill: white;
            font-family: monospace;
            font-size: 10px;
        }
        .leader-line {
            stroke: white;
            stroke-width: 2;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1>ATC Approach Trainer</h1>
    <div id="controls">
        <label for="numAircraftInput">Number of Aircraft:</label>
        <input type="number" id="numAircraftInput" value="10" min="1" max="50">
        <button id="spawnButton">Respawn Aircraft</button>
    </div>
    <div id="atc-container">
        <svg id="atc-map" viewBox="0 0 1500.75 1500.75">
             <defs>
    <style>
      .cls-1 {
        opacity: .75;
      }

      .cls-2 {
        stroke-dasharray: .96 9.61;
      }

      .cls-2, .cls-3, .cls-4, .cls-5, .cls-6, .cls-7, .cls-8, .cls-9, .cls-10, .cls-11, .cls-12, .cls-13, .cls-14, .cls-15, .cls-16, .cls-17, .cls-18, .cls-19, .cls-20, .cls-21, .cls-22, .cls-23, .cls-24, .cls-25, .cls-26, .cls-27, .cls-28 {
        stroke-miterlimit: 10;
      }

      .cls-2, .cls-3, .cls-4, .cls-5, .cls-7, .cls-8, .cls-9, .cls-10, .cls-12, .cls-13, .cls-14, .cls-15, .cls-16, .cls-17, .cls-18, .cls-19, .cls-20, .cls-21, .cls-22, .cls-23, .cls-24, .cls-25, .cls-26, .cls-27, .cls-28 {
        fill: none;
      }

      .cls-2, .cls-8, .cls-10, .cls-14, .cls-16, .cls-18, .cls-19, .cls-25 {
        stroke: #fff;
      }

      .cls-2, .cls-8, .cls-16, .cls-18, .cls-19, .cls-22, .cls-25 {
        stroke-width: 3px;
      }

      .cls-2, .cls-8, .cls-16, .cls-18, .cls-19, .cls-25 {
        stroke-linecap: round;
      }

      .cls-3, .cls-6 {
        stroke-width: .5px;
      }

      .cls-3, .cls-6, .cls-9 {
        stroke: #97999c;
      }

      .cls-4 {
        stroke-dasharray: 5 3;
      }

      .cls-4, .cls-5, .cls-7, .cls-12, .cls-13, .cls-17, .cls-20, .cls-21, .cls-23, .cls-24, .cls-26, .cls-27, .cls-28 {
        stroke: #004e1a;
      }

      .cls-5 {
        stroke-dasharray: 4.99 2.99;
      }

      .cls-29 {
        fill: #fff;
      }

      .cls-6 {
        fill: #97999c;
        font-family: Calibri-Light, Calibri;
        font-size: 12px;
        font-weight: 300;
      }

      .cls-7, .cls-10, .cls-11 {
        stroke-width: .75px;
      }

      .cls-8 {
        stroke-dasharray: .98 9.84;
      }

      .cls-9 {
        stroke-width: 1.5px;
      }

      .cls-11, .cls-22 {
        stroke: #000;
      }

      .cls-30 {
        opacity: .8;
      }

      .cls-13 {
        stroke-dasharray: 5 3;
      }

      .cls-14 {
        stroke-dasharray: 5.02 3.01;
      }

      .cls-15 {
        stroke: #00506a;
        stroke-dasharray: 5 3;
      }

      .cls-17 {
        stroke-dasharray: 4.91 2.95;
      }

      .cls-18 {
        stroke-dasharray: .97 9.66;
      }

      .cls-19 {
        stroke-dasharray: .98 9.79;
      }

      .cls-20 {
        stroke-dasharray: 4.95 2.97;
      }

      .cls-21 {
        stroke-dasharray: 4.93 2.96;
      }

      .cls-22 {
        stroke-dasharray: 5.01 3.01;
      }

      .cls-23 {
        stroke-dasharray: 5 3;
      }

      .cls-31 {
        opacity: .7;
      }

      .cls-24 {
        stroke-dasharray: 5.13 3.08;
      }

      .cls-25 {
        stroke-dasharray: .98 9.79;
      }

      .cls-26 {
        stroke-dasharray: 4.98 2.99;
      }

      .cls-27 {
        stroke-dasharray: 5.17 3.1;
      }

      .cls-28 {
        stroke-dasharray: 5 3;
      }
    </style>
  </defs>
  <g id="Layer_1" data-name="Layer 1">
    <rect class="cls-11" x=".38" y=".38" width="1500" height="1500"/>
  </g>
  <g id="Radials">
    <line class="cls-7" x1="743.31" y1="749.3" x2="834.32" y2="224.7"/>
    <polyline class="cls-7" points="1196.82 368.7 1123.75 447.51 743.31 749.3"/>
    <line class="cls-7" x1="1080.05" y1="728.35" x2="743.31" y2="749.3"/>
    <polyline class="cls-7" points="216.05 908.88 743.31 749.3 551.33 228.29"/>
    <polyline class="cls-7" points="608.64 1033.54 743.31 749.3 104.29 602.26"/>
    <polyline class="cls-7" points="599.33 856.58 743.31 749.3 1127.33 1399.99"/>
    <polyline class="cls-7" points="1345.48 1006.67 1025.24 932.52 743.31 749.3 1339.39 1280.7"/>
    <line class="cls-7" x1="1090.08" y1="183.26" x2="743.31" y2="749.3"/>
    <line class="cls-7" x1="376.52" y1="224.7" x2="632.91" y2="449.69"/>
    <line class="cls-7" x1="966.63" y1="384.77" x2="1259.87" y2="183.26"/>
    <g id="_5" data-name="5">
      <circle cx="753.06" cy="751.29" r="60"/>
      <circle class="cls-22" cx="753.06" cy="751.29" r="60"/>
    </g>
  </g>
  <g id="Points">
    <polygon class="cls-10" points="635.48 446.46 629.71 456.46 641.25 456.46 635.48 446.46"/>
    <polygon class="cls-10" points="436.45 841.38 430.67 851.38 442.22 851.38 436.45 841.38"/>
    <polygon class="cls-10" points="216.05 905.43 210.27 915.43 221.82 915.43 216.05 905.43"/>
    <polygon class="cls-10" points="426.33 671.39 420.55 681.39 432.1 681.39 426.33 671.39"/>
    <polygon class="cls-10" points="599.33 856.58 593.56 866.58 605.1 866.58 599.33 856.58"/>
    <polygon class="cls-10" points="605.78 918.37 600 928.37 611.55 928.37 605.78 918.37"/>
    <polygon class="cls-10" points="552.76 223.29 546.99 233.29 558.54 233.29 552.76 223.29"/>
    <polygon class="cls-10" points="376.52 218.04 370.75 228.04 382.3 228.04 376.52 218.04"/>
    <polygon class="cls-10" points="558.54 297.78 552.76 307.78 564.31 307.78 558.54 297.78"/>
    <polygon class="cls-10" points="834.32 221.37 828.54 231.37 840.09 231.37 834.32 221.37"/>
    <polygon class="cls-10" points="970.07 378.1 964.29 388.1 975.84 388.1 970.07 378.1"/>
    <polygon class="cls-10" points="1127.33 439.79 1121.56 449.79 1133.1 449.79 1127.33 439.79"/>
    <polygon class="cls-10" points="1196.82 366.4 1191.05 376.4 1202.6 376.4 1196.82 366.4"/>
    <polygon class="cls-10" points="1080.05 721.68 1074.27 731.68 1085.82 731.68 1080.05 721.68"/>
    <polygon class="cls-10" points="1031.66 928.37 1025.88 938.37 1037.43 938.37 1031.66 928.37"/>
    <polygon class="cls-10" points="742.94 921.71 737.17 931.71 748.72 931.71 742.94 921.71"/>
    <polygon class="cls-10" points="964.29 1115.38 958.52 1125.38 970.07 1125.38 964.29 1115.38"/>
    <polygon class="cls-10" points="1345.48 999.15 1339.71 1009.15 1351.25 1009.15 1345.48 999.15"/>
  </g>
  <g id="RTCC_Levls" data-name="RTCC Levls" class="cls-31">
    <text class="cls-6" transform="translate(496.22 507.65)"><tspan x="0" y="0">44r</tspan></text>
    <text class="cls-6" transform="translate(467.53 661.91)"><tspan x="0" y="0">47r</tspan></text>
    <text class="cls-6" transform="translate(612.7 601.2)"><tspan x="0" y="0">45r</tspan></text>
    <text class="cls-6" transform="translate(650.43 492.64)"><tspan x="0" y="0">51r</tspan></text>
    <text class="cls-6" transform="translate(591.81 700.05)"><tspan x="0" y="0">40r</tspan></text>
    <text class="cls-6" transform="translate(385.48 802.85)"><tspan x="0" y="0">36r</tspan></text>
    <text class="cls-6" transform="translate(432.05 914.97)"><tspan x="0" y="0">30r</tspan></text>
    <text class="cls-6" transform="translate(578.2 967.27)"><tspan x="0" y="0">25r</tspan></text>
    <text class="cls-6" transform="translate(678.14 893.12)"><tspan x="0" y="0">20r</tspan></text>
    <text class="cls-6" transform="translate(629.78 1055.39)"><tspan x="0" y="0">18r</tspan></text>
    <text class="cls-6" transform="translate(817.84 1054.67)"><tspan x="0" y="0">15r</tspan></text>
    <text class="cls-6" transform="translate(976.17 1026.73)"><tspan x="0" y="0">20r</tspan></text>
    <text class="cls-6" transform="translate(759.09 675.69)"><tspan x="0" y="0">20r</tspan></text>
    <text class="cls-6" transform="translate(953.96 842.26)"><tspan x="0" y="0">24r</tspan></text>
    <text class="cls-6" transform="translate(938.2 716.88)"><tspan x="0" y="0">30r</tspan></text>
    <text class="cls-6" transform="translate(1091.51 866.97)"><tspan x="0" y="0">40r</tspan></text>
    <text class="cls-6" transform="translate(1142.02 704.7)"><tspan x="0" y="0">55r</tspan></text>
    <text class="cls-6" transform="translate(1085.78 582.91)"><tspan x="0" y="0">42r</tspan></text>
    <text class="cls-6" transform="translate(907.03 533.48)"><tspan x="0" y="0">37r</tspan></text>
    <text class="cls-6" transform="translate(768.05 421)"><tspan x="0" y="0">27r</tspan></text>
    <text class="cls-6" transform="translate(853.66 385.54)"><tspan x="0" y="0">50r</tspan></text>
    <text class="cls-6" transform="translate(967.93 409.18)"><tspan x="0" y="0">30r</tspan></text>
    <text class="cls-6" transform="translate(707.15 384.11)"><tspan x="0" y="0">40r</tspan></text>
    <text class="cls-6" transform="translate(772.7 563.93)"><tspan x="0" y="0">40r</tspan></text>
  </g>
  <g id="CTA_steps" data-name="CTA steps" class="cls-1">
    <g id="_5-2" data-name="5">
      <circle class="cls-14" cx="752.94" cy="750.9" r="53.73" transform="translate(-110.56 130.3) rotate(-9.22)"/>
    </g>
    <g id="_10" data-name="10">
      <g>
        <path class="cls-12" d="M774.9,648.27c-.79-.25-1.59-.49-2.39-.71"/>
        <path class="cls-21" d="M769.65,646.79c-8.54-2.18-17.49-3.34-26.7-3.34-59.35,0-107.46,48.11-107.46,107.46,0,27.75,10.51,53.04,27.78,72.1"/>
        <path class="cls-12" d="M664.26,824.1c.57.61,1.14,1.21,1.72,1.81"/>
      </g>
    </g>
    <g id="_30" data-name="30">
      <g>
        <path class="cls-12" d="M729.67,1073.02c.83.03,1.66.06,2.5.09"/>
        <path class="cls-4" d="M735.17,1073.2c2.58.06,5.17.09,7.77.09,178.05,0,322.39-144.34,322.39-322.39s-144.34-322.39-322.39-322.39-322.39,144.34-322.39,322.39c0,80.85,29.76,154.75,78.93,211.34"/>
        <path class="cls-12" d="M500.47,963.38c.55.63,1.1,1.25,1.65,1.87"/>
      </g>
    </g>
    <g id="_40" data-name="40">
      <g>
        <path class="cls-12" d="M613.38,1160.89c.79.25,1.59.5,2.39.75"/>
        <path class="cls-28" d="M618.64,1162.51c39.35,11.87,81.08,18.25,124.31,18.25,237.4,0,429.85-192.45,429.85-429.85s-192.45-429.85-429.85-429.85-429.85,192.45-429.85,429.85c0,148.84,75.65,280.02,190.6,357.17"/>
        <path class="cls-12" d="M504.94,1108.91c.69.46,1.39.92,2.08,1.38"/>
      </g>
    </g>
    <g id="_15" data-name="15">
      <g>
        <path class="cls-12" d="M765.72,591.31c-.82-.12-1.65-.23-2.48-.33"/>
        <path class="cls-23" d="M760.26,590.63c-5.69-.61-11.47-.92-17.32-.92-89.03,0-161.19,72.17-161.19,161.19s72.17,161.19,161.19,161.19,161.19-72.17,161.19-161.19c0-29.95-8.17-58-22.4-82.02"/>
        <path class="cls-12" d="M880.96,667.59c-.43-.71-.87-1.42-1.31-2.13"/>
      </g>
    </g>
    <g>
      <line class="cls-12" x1="879.64" y1="665.47" x2="877.15" y2="665.61"/>
      <line class="cls-17" x1="874.21" y1="665.78" x2="781.51" y2="671.16"/>
      <polyline class="cls-12" points="780.04 671.25 777.54 671.39 777.22 668.91"/>
      <polyline class="cls-27" points="776.82 665.84 774.51 648.16 766.32 593.72"/>
      <line class="cls-12" x1="766.09" y1="592.18" x2="765.72" y2="589.71"/>
    </g>
    <g>
      <line class="cls-12" x1="668.14" y1="828.05" x2="669.69" y2="830.01"/>
      <polyline class="cls-20" points="671.53 832.34 692.11 858.37 715.21 865.36 756.05 868.05 785.6 860.52 794.73 860.52 810.32 858.37 836.64 848.05 866.9 848.86"/>
      <line class="cls-12" x1="868.39" y1="848.9" x2="870.88" y2="848.97"/>
    </g>
    <circle id="AV_CTA" data-name="AV CTA" class="cls-13" cx="609.36" cy="1032.6" r="127.5"/>
    <g>
      <line class="cls-12" x1="712.58" y1="957.75" x2="715.04" y2="957.33"/>
      <path class="cls-5" d="M717.99,956.82l152.89-26.44,68.03-22.21,61.61-113.19-16.48-85.25-64.62-81.51c-38.83-55.75-103.4-92.23-176.48-92.23-118.7,0-214.93,96.23-214.93,214.93,0,59.05,23.82,112.55,62.37,151.39"/>
      <path class="cls-12" d="M591.44,903.36c.59.59,1.18,1.17,1.78,1.75"/>
    </g>
    <g>
      <path class="cls-12" d="M569.66,953.05c-.72.43-1.43.86-2.13,1.31l.11,2.5"/>
      <line class="cls-24" x1="567.78" y1="959.92" x2="573.97" y2="1097.8"/>
      <path class="cls-12" d="M574.04,1099.34l.11,2.5c.74.38,1.49.75,2.24,1.11"/>
      <path class="cls-26" d="M579.11,1104.18c10.38,4.51,21.83,7.01,33.86,7.01,32.27,0,60.35-17.99,74.74-44.48l-4.26-88.04c-15.28-22.61-41.14-37.48-70.48-37.48-15.28,0-29.63,4.03-42.02,11.1"/>
    </g>
    <g id="_55" data-name="55">
      <circle class="cls-15" cx="742.94" cy="750.89" r="591.04"/>
    </g>
  </g>
  <g id="RTCC" class="cls-30">
    <circle id="Border" class="cls-9" cx="758.83" cy="750.9" r="429.85"/>
    <g id="Internals">
      <polyline class="cls-3" points="644.46 359.75 721.48 441.78 738.32 571.09 663.45 597.6 612.23 551.39 553.48 608.7 535.93 556.76"/>
      <polyline class="cls-3" points="328.98 751.99 405.72 735.87 375.81 675.87 422.02 556.76 535.93 556.76 566.73 495.51 535.21 424.94 644.46 359.75 625.88 342.01"/>
      <polyline class="cls-3" points="405.72 735.87 486.72 751.99 518.73 735.87 591.81 620.88 553.48 608.7"/>
      <polyline class="cls-3" points="591.81 620.88 609.36 629.12 644.46 623.03 663.45 597.6"/>
      <polyline class="cls-3" points="351.13 887.49 533.42 764.52 627.63 713.66 635.15 667.09 726.85 649.9 738.32 614.79 810.67 634.14 856.88 690.73 863.33 765.96 905.72 857.54 991.21 896.23 1061.66 946.61 1142.32 945.28"/>
      <polyline class="cls-3" points="518.73 735.87 533.42 764.52 535.93 821.48 504.05 880.94 519.99 965.84 436.45 1035.24"/>
      <polyline class="cls-3" points="788.11 1179.77 755.87 1062.2 653.78 1024.58 793.48 898.14 843.99 889.18 913.84 1072.94 886.95 1161.34"/>
      <polygon class="cls-3" points="560.29 990.55 602.2 987.69 605.78 957.24 591.81 933.24 552.76 948.29 560.29 990.55"/>
      <polyline class="cls-3" points="695.58 325.68 757.3 349.72 738.32 396.64 751.21 459.69 806.02 470.43 806.02 559.27 810.67 634.14"/>
      <polyline class="cls-3" points="786.71 321.94 808.52 437.84 806.02 470.43"/>
      <polyline class="cls-3" points="806.02 559.27 909.18 647.39 1043.87 621.96 1077.18 661 1083.63 703.27 1091.87 744.46 1188.61 758.46"/>
      <polyline class="cls-3" points="1166.2 613.36 1083.63 703.27 1028.46 735.87 973.66 799.81 863.33 765.96"/>
      <polyline class="cls-3" points="991.21 896.23 1014.77 832.58 1028.46 735.87"/>
      <polyline class="cls-3" points="808.52 437.84 926.38 415.63 967.57 450.73 991.21 424.94 1039.21 460.05 1002.67 586.85 1043.87 621.96"/>
      <line class="cls-3" x1="932.04" y1="357.38" x2="926.38" y2="415.63"/>
      <line class="cls-3" x1="1037.43" y1="423.56" x2="1039.21" y2="460.05"/>
    </g>
  </g>
  <g id="Layer_7" data-name="Layer 7">
    <g>
      <line class="cls-16" x1="768.05" y1="750.9" x2="768.55" y2="750.86"/>
      <line class="cls-18" x1="778.17" y1="749.99" x2="858.02" y2="742.79"/>
      <line class="cls-16" x1="862.83" y1="742.36" x2="863.33" y2="742.32"/>
    </g>
    <g>
      <line class="cls-16" x1="630.88" y1="763.27" x2="631.38" y2="763.23"/>
      <line class="cls-19" x1="641.13" y1="762.35" x2="722.03" y2="755.05"/>
      <line class="cls-16" x1="726.9" y1="754.61" x2="727.4" y2="754.57"/>
    </g>
    <g>
      <line class="cls-16" x1="765.72" y1="763.39" x2="766.1" y2="763.71"/>
      <line class="cls-8" x1="773.64" y1="770.03" x2="836.25" y2="822.43"/>
      <line class="cls-16" x1="840.02" y1="825.59" x2="840.4" y2="825.91"/>
    </g>
    <g>
      <line class="cls-16" x1="660.94" y1="675.69" x2="661.33" y2="676.01"/>
      <line class="cls-25" x1="668.83" y1="682.29" x2="731.12" y2="734.43"/>
      <line class="cls-16" x1="734.87" y1="737.57" x2="735.25" y2="737.89"/>
    </g>
    <g>
      <line class="cls-16" x1="609.36" y1="1008.21" x2="609.34" y2="1007.71"/>
      <line class="cls-2" x1="608.91" y1="998.11" x2="605.34" y2="918.4"/>
      <line class="cls-16" x1="605.13" y1="913.6" x2="605.1" y2="913.1"/>
    </g>
    <circle class="cls-29" cx="684.61" cy="758.34" r="3"/>
    <circle class="cls-29" cx="702.21" cy="710.34" r="3"/>
    <circle class="cls-29" cx="661.55" cy="676.49" r="3"/>
    <circle class="cls-29" cx="839.58" cy="825.03" r="3"/>
    <circle class="cls-29" cx="798.93" cy="791.18" r="3"/>
    <circle class="cls-29" cx="630.88" cy="763.27" r="3"/>
    <circle class="cls-29" cx="863.45" cy="742.44" r="3"/>
    <circle class="cls-29" cx="809.72" cy="747.37" r="3"/>
    <circle class="cls-29" cx="605.78" cy="913.1" r="3"/>
    <circle class="cls-29" cx="608.1" cy="965.99" r="3"/>
  </g>
</svg>
    </div>

    <script>
    // --- Configuration ---
    const AIRFIELD_CENTER_X = 750;
    const AIRFIELD_CENTER_Y = 750;
    const MIN_SPAWN_DISTANCE = 180;
    const MAX_SPAWN_DISTANCE = 600;
    const AIRCRAFT_SIZE = 10;
    const LABEL_OFFSET_X = 15;

    // For velocity leader lines
    // 1 NM = 1852 meters, but SVG units are pixels (assume 1 px = 1 m for simplicity, adjust as needed)
    // 1 knot = 1 NM/hr = 1.852 km/hr = 1852 m/hr; so for 1 min: 1 NM/hr * 1/60 hr = 0.01667 NM/min
    // But we want distance covered in 1 min: knots * (1852/60) meters (or px if 1 px = 1 m)
    function knotsToPixels(knots) {
        // 1 knot = 1852 meters/hr, per minute = 1852/60 meters
        // For SVG units, let's assume 1 px = 1 meter (you may adjust this for realism)
        return knots * (100 / 60); // distance in pixels for 1 minute
    }

    let aircrafts = [];
    let radialsData = [];

    class Aircraft {
        constructor(callsign, x, y, level, speed, heading) {
            this.id = 'ac-' + Date.now() + Math.random().toFixed(0);
            this.callsign = callsign;
            this.x = x;
            this.y = y;
            this.level = level;
            this.speed = speed; // knots
            this.heading = heading;
            this.svgElement = null;
        }

        getDisplayLevel() {
            return String(this.level).padStart(3, '0');
        }

        getDisplaySpeed() {
            return String(this.speed).padStart(2, '0');
        }

        updatePosition(newX, newY) {
            this.x = newX;
            this.y = newY;
            if (this.svgElement) {
                this.svgElement.setAttribute('transform', `translate(${this.x}, ${this.y})`);
            }
        }
    }

    function generateCallsign() {
        const prefixes = ['UAL', 'AAL', 'DAL', 'SWA', 'EZY', 'RYR', 'BAW', 'KLM', 'AFR'];
        const suffix = Math.floor(100 + Math.random() * 900);
        return prefixes[Math.floor(Math.random() * prefixes.length)] + suffix;
    }

    function getRandomLevel() {
        return Math.floor(100 + Math.random() * 25) * 10;
    }

    function getRandomSpeed() {
        return Math.floor(25 + Math.random() * 15); // 25-40 knots
    }

    function getAngle(x1, y1, x2, y2) {
    // Returns angle in degrees from (x1, y1) to (x2, y2)
    const dx = x2 - x1;
    const dy = y2 - y1;
    return Math.atan2(dy, dx) * 180 / Math.PI; // 0 degrees is along +x axis
}

    // --- Make labels always upright (not rotated) ---
    function drawAircraft(aircraft) {
        const svg = document.getElementById('atc-map');

        // Aircraft group: only symbol rotates, label stays readable
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute('id', aircraft.id);
        g.setAttribute('class', 'aircraft');
        g.setAttribute('transform', `translate(${aircraft.x}, ${aircraft.y})`);

        // Subgroup for symbol, rotated to heading
        const symbolGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        symbolGroup.setAttribute('transform', `rotate(${aircraft.heading})`);

        // The square dot (aircraft symbol)
        const dot = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        dot.setAttribute('x', -AIRCRAFT_SIZE / 2);
        dot.setAttribute('y', -AIRCRAFT_SIZE / 2);
        dot.setAttribute('width', AIRCRAFT_SIZE);
        dot.setAttribute('height', AIRCRAFT_SIZE);
        dot.setAttribute('fill', 'white');
        dot.setAttribute('stroke', 'black');
        dot.setAttribute('stroke-width', '1');

        symbolGroup.appendChild(dot);

        // --- Leader Line ---
        // Compute leader line endpoint (1 min flying time)
        const speed = aircraft.speed; // knots
        const heading = aircraft.heading;
        // Convert heading to radians (SVG 0Â° is along +X so rotate by -90)
        const rad = (heading) * Math.PI / 180;
        const leaderLength = knotsToPixels(speed);
        const x2 = Math.cos(rad) * leaderLength;
        const y2 = Math.sin(rad) * leaderLength;

        const leaderLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
        leaderLine.setAttribute('class', 'leader-line');
        leaderLine.setAttribute('x1', '0');
        leaderLine.setAttribute('y1', '0');
        leaderLine.setAttribute('x2', x2.toFixed(1));
        leaderLine.setAttribute('y2', y2.toFixed(1));

        symbolGroup.appendChild(leaderLine);

        // Text label group (ALWAYS upright/readable)
        const textGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        textGroup.setAttribute('transform', `translate(${LABEL_OFFSET_X}, 0)`);

        const callsignText = document.createElementNS("http://www.w3.org/2000/svg", "text");
        callsignText.setAttribute('x', 0);
        callsignText.setAttribute('y', -5);
        callsignText.setAttribute('font-size', '10px');
        callsignText.setAttribute('fill', 'white');
        callsignText.textContent = aircraft.callsign;

        const infoText = document.createElementNS("http://www.w3.org/2000/svg", "text");
        infoText.setAttribute('x', 0);
        infoText.setAttribute('y', 5);
        infoText.setAttribute('font-size', '10px');
        infoText.setAttribute('fill', 'white');
        infoText.textContent = `${aircraft.getDisplayLevel()} ${aircraft.getDisplaySpeed()}`;

        textGroup.appendChild(callsignText);
        textGroup.appendChild(infoText);

        g.appendChild(symbolGroup);
        g.appendChild(textGroup);

        svg.appendChild(g);
        aircraft.svgElement = g;
    }

    function spawnAircraft(numAircraft) {
        // Remove existing aircraft from SVG
        document.getElementById('atc-map').querySelectorAll('.aircraft').forEach(el => el.remove());
        aircrafts = [];

        for (let i = 0; i < numAircraft; i++) {
            let x, y, initialHeading;
            let spawnAngle;
            let dist = MIN_SPAWN_DISTANCE + Math.random() * (MAX_SPAWN_DISTANCE - MIN_SPAWN_DISTANCE);

            if (radialsData.length > 0 && Math.random() < 0.7) {
                // Pick a random radial line
                const radial = radialsData[Math.floor(Math.random() * radialsData.length)];
                let x1, y1, x2, y2;
                if (radial.tagName === 'line') {
                    x1 = parseFloat(radial.getAttribute('x1'));
                    y1 = parseFloat(radial.getAttribute('y1'));
                    x2 = parseFloat(radial.getAttribute('x2'));
                    y2 = parseFloat(radial.getAttribute('y2'));
                } else if (radial.tagName === 'path') {
                    x1 = AIRFIELD_CENTER_X;
                    y1 = AIRFIELD_CENTER_Y;
                    spawnAngle = Math.random() * Math.PI * 2;
                    x2 = x1 + Math.cos(spawnAngle) * dist;
                    y2 = y1 + Math.sin(spawnAngle) * dist;
                } else {
                    x1 = AIRFIELD_CENTER_X;
                    y1 = AIRFIELD_CENTER_Y;
                    spawnAngle = Math.random() * Math.PI * 2;
                    x2 = x1 + Math.cos(spawnAngle) * dist;
                    y2 = y1 + Math.sin(spawnAngle) * dist;
                }
                const t = dist / Math.hypot(x2 - x1, y2 - y1);
                x = x1 + (x2 - x1) * t;
                y = y1 + (y2 - y1) * t;
            } else {
                spawnAngle = Math.random() * Math.PI * 2;
                x = AIRFIELD_CENTER_X + Math.cos(spawnAngle) * dist;
                y = AIRFIELD_CENTER_Y + Math.sin(spawnAngle) * dist;
            }

            initialHeading = getAngle(x, y, AIRFIELD_CENTER_X, AIRFIELD_CENTER_Y);
            //if (Math.random() < 0.3) {
              //  initialHeading += (Math.random() * 10) - 5;
            //}

            const callsign = generateCallsign();
            const level = getRandomLevel();
            const speed = getRandomSpeed();

            const newAircraft = new Aircraft(callsign, x, y, level, speed, initialHeading);
            aircrafts.push(newAircraft);
            drawAircraft(newAircraft);
        }
    }

    function initATCApp() {
        const radialsGroup = document.getElementById('radialsGroup');
        if (radialsGroup) {
            radialsData = Array.from(radialsGroup.querySelectorAll('path, line'));
        }
        spawnAircraft(parseInt(document.getElementById('numAircraftInput').value || 10));
        document.getElementById('spawnButton').onclick = () => {
            spawnAircraft(parseInt(document.getElementById('numAircraftInput').value || 10));
        };
    }

    document.addEventListener('DOMContentLoaded', initATCApp);
    </script>
</body>
</html>